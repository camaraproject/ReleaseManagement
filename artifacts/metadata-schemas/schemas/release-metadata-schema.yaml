$schema: "http://json-schema.org/draft-07/schema#"
title: CAMARA Release Metadata Schema
description: |
  Schema for release-metadata.yaml file generated on release branches.
  The release-metadata.yaml file is automatically created during release preparation, validated against this schema, and committed before tagging.
  The generated release-metadata.yaml file provides complete release history and is preserved in the release tag.

type: object
required:
  - repository
  - apis
properties:
  repository:
    type: object
    description: Repository-level release metadata including generated fields
    required:
      - repository_name
      - release_tag
      - release_type
      - release_date
      - src_commit_sha
    properties:
      repository_name:
        type: string
        description: |
          GitHub repository name at release creation time (immutable, not affected by repository renames).
          Generated during release creation.
        pattern: "^[A-Za-z][A-Za-z0-9-]*$"
        examples:
          - "QualityOnDemand"
          - "DeviceLocation"
          - "SimSwap"

      release_tag:
        type: string
        description: CAMARA release tag (derived from target_release_tag in release-plan.yaml)
        pattern: "^r[1-9]\\d*\\.[1-9]\\d*$"
        examples:
          - "r4.1"
          - "r5.3"

      release_date:
        type: [string, "null"]
        description: |
          Release finalization timestamp in ISO 8601 format (UTC).
          Set to null during release preparation. Populated by automation
          in the final "release commit" immediately before tag creation.
          Represents the official release timestamp.
        format: date-time
        pattern: "^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}Z$"
        examples:
          - "2025-11-22T14:30:00Z"
          - "2026-03-15T09:15:30Z"

      release_type:
        type: string
        description: |
          Release type (derived from target_release_type in release-plan.yaml):
          - pre-release-alpha: All APIs at alpha or higher status (mix of alpha/rc/public allowed for unchanged APIs)
          - pre-release-rc: All APIs at rc or public status
          - public-release: All APIs at public status
          - maintenance-release: Maintenance/hotfix release
        enum:
          - "pre-release-alpha"
          - "pre-release-rc"
          - "public-release"
          - "maintenance-release"

      src_commit_sha:
        type: [string, "null"]
        description: |
          Commit SHA from main or maintenance branch from which this release
          was created. Set to null during release preparation. Populated by
          automation at finalization to the HEAD commit SHA of the base branch
          at the time the release branch was created. Release branches are
          immutable after creation - corrections require abandoning and
          retriggering the release from updated main.
        pattern: "^[a-f0-9]{40}$"
        examples:
          - "abcd1234efgh5678ijkl9012mnop3456qrst7890"

      release_notes:
        type: string
        description: Optional release notes or description (manual or generated)
        examples:
          - "Pre-release for CAMARA Fall26 meta-release."
          - "Maintenance release with critical bug fixes."

  dependencies:
    type: object
    description: |
      Release dependencies with both release_tag and resolved documentation versions.
      Format: "rX.Y (semantic-version)". Derived from release-plan.yaml with version resolution.
    properties:
      commonalities_release:
        type: string
        description: Commonalities release_tag and resolved version
        pattern: "^r[1-9]\\d*\\.[1-9]\\d* \\(\\d+\\.\\d+\\.\\d+(-[a-z]+\\.\\d+)?\\)$"
        examples:
          - "r4.2 (1.2.0-rc.1)"
          - "r4.3 (1.3.0)"

      identity_consent_management_release:
        type: string
        description: Identity and Consent Management release_tag and resolved version
        pattern: "^r[1-9]\\d*\\.[1-9]\\d* \\(\\d+\\.\\d+\\.\\d+(-[a-z]+\\.\\d+)?\\)$"
        examples:
          - "r4.3 (1.1.0)"
          - "r5.1 (2.0.0-rc.2)"

  apis:
    type: array
    description: List of APIs included in this release with actual versions
    minItems: 1
    items:
      type: object
      required:
        - api_name
        - api_version
        - api_title
      properties:
        api_name:
          type: string
          description: API name (kebab-case), leading identifier from which file_name is derived
          pattern: "^[a-z][a-z0-9-]*$"
          examples:
            - "location-verification"
            - "quality-on-demand"

        api_version:
          type: string
          description: |
            Actual API version with pre-release extension if applicable.
            Format: X.Y.Z or X.Y.Z-alpha.N or X.Y.Z-rc.N
            Derived from target_api_version in release-plan.yaml with extension calculation.
          pattern: "^\\d+\\.\\d+\\.\\d+(-[a-z]+\\.\\d+)?$"
          examples:
            - "1.0.0"
            - "0.5.0-alpha.1"
            - "3.2.0-rc.2"

        api_title:
          type: string
          description: Human-readable API title from OpenAPI info.title (generated during release branch creation)
          examples:
            - "Quality On Demand"
            - "Location Verification"
            - "SIM Swap"
